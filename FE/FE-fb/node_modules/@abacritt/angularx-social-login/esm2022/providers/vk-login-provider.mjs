import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
const permissionTypes = {
    notify: 1,
    friends: 2,
    photos: 4,
    audio: 8,
    video: 16,
    offers: 32,
    questions: 64,
    pages: 128,
    links: 256,
    status: 1024,
    notes: 2048,
    messages: 4096,
    wall: 8192,
    ads: 32768,
    offline: 65536,
    docs: 131072,
    groups: 262144,
    notifications: 524288,
    stats: 1048576,
    email: 4194304,
    market: 134217728
};
export class VKLoginProvider extends BaseLoginProvider {
    constructor(clientId, initOptions = {
        fields: 'photo_max,contacts',
        version: '5.131',
    }) {
        super();
        this.clientId = clientId;
        this.initOptions = initOptions;
        this.VK_API_URL = '//vk.com/js/api/openapi.js';
        this.VK_API_GET_USER = 'users.get';
    }
    static { this.PROVIDER_ID = 'VK'; }
    initialize() {
        return new Promise((resolve, reject) => {
            try {
                this.loadScript(VKLoginProvider.PROVIDER_ID, this.VK_API_URL, () => {
                    VK.init({
                        apiId: this.clientId,
                    });
                    resolve();
                });
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return new Promise((resolve) => this.getLoginStatusInternal(resolve));
    }
    signIn(permissions) {
        if (permissions?.includes('offers')) {
            console.warn('The "offers" permission is outdated.');
        }
        if (permissions?.includes('questions')) {
            console.warn('The "questions" permission is outdated.');
        }
        if (permissions?.includes('messages')) {
            console.warn('The "messages" permission is unavailable for non-standalone applications.');
        }
        const scope = permissions?.reduce((accumulator, current) => {
            const index = Object.keys(permissionTypes).findIndex(pt => pt === current);
            return index > -1 ? accumulator + permissionTypes[current] : 0;
        }, 0);
        return new Promise((resolve) => this.signInInternal(resolve, scope));
    }
    signOut() {
        return new Promise((resolve) => {
            VK.Auth.logout(() => {
                resolve();
            });
        });
    }
    signInInternal(resolve, scope) {
        VK.Auth.login((loginResponse) => {
            if (loginResponse.status === 'connected') {
                this.getUser(loginResponse.session.mid, loginResponse.session.sid, resolve);
            }
        }, scope);
    }
    getUser(userId, token, resolve) {
        VK.Api.call(this.VK_API_GET_USER, {
            user_id: userId,
            fields: this.initOptions.fields,
            v: this.initOptions.version,
        }, (userResponse) => {
            resolve(this.createUser(Object.assign({}, { token }, userResponse.response[0])));
        });
    }
    getLoginStatusInternal(resolve) {
        VK.Auth.getLoginStatus((loginResponse) => {
            if (loginResponse.status === 'connected') {
                this.getUser(loginResponse.session.mid, loginResponse.session.sid, resolve);
            }
        });
    }
    createUser(response) {
        const user = new SocialUser();
        user.id = response.id;
        user.name = `${response.first_name} ${response.last_name}`;
        user.photoUrl = response.photo_max;
        user.authToken = response.token;
        return user;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmstbG9naW4tcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9saWIvc3JjL3Byb3ZpZGVycy92ay1sb2dpbi1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJckQsTUFBTSxlQUFlLEdBQUc7SUFDdEIsTUFBTSxFQUFFLENBQUM7SUFDVCxPQUFPLEVBQUUsQ0FBQztJQUNWLE1BQU0sRUFBRSxDQUFDO0lBQ1QsS0FBSyxFQUFFLENBQUM7SUFDUixLQUFLLEVBQUUsRUFBRTtJQUNULE1BQU0sRUFBRSxFQUFFO0lBQ1YsU0FBUyxFQUFFLEVBQUU7SUFDYixLQUFLLEVBQUUsR0FBRztJQUNWLEtBQUssRUFBRSxHQUFHO0lBQ1YsTUFBTSxFQUFFLElBQUk7SUFDWixLQUFLLEVBQUUsSUFBSTtJQUNYLFFBQVEsRUFBRSxJQUFJO0lBQ2QsSUFBSSxFQUFFLElBQUk7SUFDVixHQUFHLEVBQUUsS0FBSztJQUNWLE9BQU8sRUFBRSxLQUFLO0lBQ2QsSUFBSSxFQUFFLE1BQU07SUFDWixNQUFNLEVBQUUsTUFBTTtJQUNkLGFBQWEsRUFBRSxNQUFNO0lBQ3JCLEtBQUssRUFBRSxPQUFPO0lBQ2QsS0FBSyxFQUFFLE9BQU87SUFDZCxNQUFNLEVBQUUsU0FBUztDQUNsQixDQUFDO0FBRUYsTUFBTSxPQUFPLGVBQWdCLFNBQVEsaUJBQWlCO0lBQ3BELFlBQ1UsUUFBZ0IsRUFDaEIsY0FBYztRQUNwQixNQUFNLEVBQUUsb0JBQW9CO1FBQzVCLE9BQU8sRUFBRSxPQUFPO0tBQ2pCO1FBRUQsS0FBSyxFQUFFLENBQUM7UUFOQSxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLGdCQUFXLEdBQVgsV0FBVyxDQUdsQjtRQU9jLGVBQVUsR0FBRyw0QkFB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LElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUNoQyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlTG9naW5Qcm92aWRlciB9IGZyb20gJy4uL2VudGl0aWVzL2Jhc2UtbG9naW4tcHJvdmlkZXInO1xyXG5pbXBvcnQgeyBTb2NpYWxVc2VyIH0gZnJvbSAnLi4vZW50aXRpZXMvc29jaWFsLXVzZXInO1xyXG5cclxuZGVjbGFyZSBsZXQgVks6IGFueTtcclxuXHJcbmNvbnN0IHBlcm1pc3Npb25UeXBlcyA9IHtcclxuICBub3RpZnk6IDEsXHJcbiAgZnJpZW5kczogMixcclxuICBwaG90b3M6IDQsXHJcbiAgYXVkaW86IDgsXHJcbiAgdmlkZW86IDE2LFxyXG4gIG9mZmVyczogMzIsXHJcbiAgcXVlc3Rpb25zOiA2NCxcclxuICBwYWdlczogMTI4LFxyXG4gIGxpbmtzOiAyNTYsXHJcbiAgc3RhdHVzOiAxMDI0LFxyXG4gIG5vdGVzOiAyMDQ4LFxyXG4gIG1lc3NhZ2VzOiA0MDk2LFxyXG4gIHdhbGw6IDgxOTIsXHJcbiAgYWRzOiAzMjc2OCxcclxuICBvZmZsaW5lOiA2NTUzNiwgXHJcbiAgZG9jczogMTMxMDcyLFxyXG4gIGdyb3VwczogMjYyMTQ0LFxyXG4gIG5vdGlmaWNhdGlvbnM6IDUyNDI4OCxcclxuICBzdGF0czogMTA0ODU3NixcclxuICBlbWFpbDogNDE5NDMwNCxcclxuICBtYXJrZXQ6IDEzNDIxNzcyOFxyXG59O1xyXG5cclxuZXhwb3J0IGNsYXNzIFZLTG9naW5Qcm92aWRlciBleHRlbmRzIEJhc2VMb2dpblByb3ZpZGVyIHtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgY2xpZW50SWQ6IHN0cmluZyxcclxuICAgIHByaXZhdGUgaW5pdE9wdGlvbnMgPSB7XHJcbiAgICAgIGZpZWxkczogJ3Bob3RvX21heCxjb250YWN0cycsXHJcbiAgICAgIHZlcnNpb246ICc1LjEzMScsXHJcbiAgICB9XHJcbiAgKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBQUk9WSURFUl9JRDogc3RyaW5nID0gJ1ZLJztcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBWS19BUElfVVJMID0gJy8vdmsuY29tL2pzL2FwaS9vcGVuYXBpLmpzJztcclxuICBwcml2YXRlIHJlYWRvbmx5IFZLX0FQSV9HRVRfVVNFUiA9ICd1c2Vycy5nZXQnO1xyXG5cclxuICBpbml0aWFsaXplKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICB0aGlzLmxvYWRTY3JpcHQoXHJcbiAgICAgICAgICBWS0xvZ2luUHJvdmlkZXIuUFJPVklERVJfSUQsXHJcbiAgICAgICAgICB0aGlzLlZLX0FQSV9VUkwsXHJcbiAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgIFZLLmluaXQoe1xyXG4gICAgICAgICAgICAgIGFwaUlkOiB0aGlzLmNsaWVudElkLFxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRMb2dpblN0YXR1cygpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxTb2NpYWxVc2VyPigocmVzb2x2ZTogKHZhbHVlOiBTb2NpYWxVc2VyKSA9PiB2b2lkKSA9PlxyXG4gICAgICB0aGlzLmdldExvZ2luU3RhdHVzSW50ZXJuYWwocmVzb2x2ZSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBzaWduSW4ocGVybWlzc2lvbnM6IHN0cmluZ1tdKTogUHJvbWlzZTxTb2NpYWxVc2VyPiB7XHJcbiAgICBpZiAocGVybWlzc2lvbnM/LmluY2x1ZGVzKCdvZmZlcnMnKSkge1xyXG4gICAgICBjb25zb2xlLndhcm4oJ1RoZSBcIm9mZmVyc1wiIHBlcm1pc3Npb24gaXMgb3V0ZGF0ZWQuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHBlcm1pc3Npb25zPy5pbmNsdWRlcygncXVlc3Rpb25zJykpIHtcclxuICAgICAgY29uc29sZS53YXJuKCdUaGUgXCJxdWVzdGlvbnNcIiBwZXJtaXNzaW9uIGlzIG91dGRhdGVkLicpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChwZXJtaXNzaW9ucz8uaW5jbHVkZXMoJ21lc3NhZ2VzJykpIHtcclxuICAgICAgY29uc29sZS53YXJuKCdUaGUgXCJtZXNzYWdlc1wiIHBlcm1pc3Npb24gaXMgdW5hdmFpbGFibGUgZm9yIG5vbi1zdGFuZGFsb25lIGFwcGxpY2F0aW9ucy4nKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzY29wZSA9IHBlcm1pc3Npb25zPy5yZWR1Y2UoKGFjY3VtdWxhdG9yLCBjdXJyZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSBPYmplY3Qua2V5cyhwZXJtaXNzaW9uVHlwZXMpLmZpbmRJbmRleChwdCA9PiBwdCA9PT0gY3VycmVudCk7XHJcbiAgICAgICAgcmV0dXJuIGluZGV4ID4gLTEgPyBhY2N1bXVsYXRvciArIHBlcm1pc3Npb25UeXBlc1tjdXJyZW50XSA6IDA7XHJcbiAgICAgIH0sIDApO1xyXG5cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxTb2NpYWxVc2VyPigocmVzb2x2ZTogKHZhbHVlOiBTb2NpYWxVc2VyKSA9PiB2b2lkKSA9PlxyXG4gICAgICB0aGlzLnNpZ25JbkludGVybmFsKHJlc29sdmUsIHNjb3BlKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHNpZ25PdXQoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmU6ICh2YWx1ZTogdm9pZCB8IFByb21pc2VMaWtlPHZvaWQ+KSA9PiB2b2lkKSA9PiB7XHJcbiAgICAgIFZLLkF1dGgubG9nb3V0KCgpID0+IHtcclxuICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNpZ25JbkludGVybmFsKFxyXG4gICAgcmVzb2x2ZTogKHZhbHVlOiBTb2NpYWxVc2VyKSA9PiB2b2lkLCBcclxuICAgIHNjb3BlOmFueVxyXG4gICkge1xyXG4gICAgVksuQXV0aC5sb2dpbigobG9naW5SZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgIGlmIChsb2dpblJlc3BvbnNlLnN0YXR1cyA9PT0gJ2Nvbm5lY3RlZCcpIHtcclxuICAgICAgICB0aGlzLmdldFVzZXIoXHJcbiAgICAgICAgICBsb2dpblJlc3BvbnNlLnNlc3Npb24ubWlkLFxyXG4gICAgICAgICAgbG9naW5SZXNwb25zZS5zZXNzaW9uLnNpZCxcclxuICAgICAgICAgIHJlc29sdmVcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9LCBzY29wZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFVzZXIoXHJcbiAgICB1c2VySWQ6IG51bWJlciwgXHJcbiAgICB0b2tlbjogc3RyaW5nLCBcclxuICAgIHJlc29sdmU6ICh2YWx1ZTogU29jaWFsVXNlcikgPT4gdm9pZFxyXG4gICkge1xyXG4gICAgVksuQXBpLmNhbGwoXHJcbiAgICAgIHRoaXMuVktfQVBJX0dFVF9VU0VSLFxyXG4gICAgICB7XHJcbiAgICAgICAgdXNlcl9pZDogdXNlcklkLFxyXG4gICAgICAgIGZpZWxkczogdGhpcy5pbml0T3B0aW9ucy5maWVsZHMsXHJcbiAgICAgICAgdjogdGhpcy5pbml0T3B0aW9ucy52ZXJzaW9uLFxyXG4gICAgICB9LFxyXG4gICAgICAodXNlclJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICByZXNvbHZlKFxyXG4gICAgICAgICAgdGhpcy5jcmVhdGVVc2VyKFxyXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCB7IHRva2VuIH0sIHVzZXJSZXNwb25zZS5yZXNwb25zZVswXSlcclxuICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRMb2dpblN0YXR1c0ludGVybmFsKHJlc29sdmU6ICh2YWx1ZTogU29jaWFsVXNlcikgPT4gdm9pZCkge1xyXG4gICAgVksuQXV0aC5nZXRMb2dpblN0YXR1cygobG9naW5SZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgIGlmIChsb2dpblJlc3BvbnNlLnN0YXR1cyA9PT0gJ2Nvbm5lY3RlZCcpIHtcclxuICAgICAgICB0aGlzLmdldFVzZXIoXHJcbiAgICAgICAgICBsb2dpblJlc3BvbnNlLnNlc3Npb24ubWlkLFxyXG4gICAgICAgICAgbG9naW5SZXNwb25zZS5zZXNzaW9uLnNpZCxcclxuICAgICAgICAgIHJlc29sdmVcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlVXNlcihyZXNwb25zZTogYW55KTogU29jaWFsVXNlciB7XHJcbiAgICBjb25zdCB1c2VyOiBTb2NpYWxVc2VyID0gbmV3IFNvY2lhbFVzZXIoKTtcclxuICAgIHVzZXIuaWQgPSByZXNwb25zZS5pZDtcclxuICAgIHVzZXIubmFtZSA9IGAke3Jlc3BvbnNlLmZpcnN0X25hbWV9ICR7cmVzcG9uc2UubGFzdF9uYW1lfWA7XHJcbiAgICB1c2VyLnBob3RvVXJsID0gcmVzcG9uc2UucGhvdG9fbWF4O1xyXG4gICAgdXNlci5hdXRoVG9rZW4gPSByZXNwb25zZS50b2tlbjtcclxuICAgIHJldHVybiB1c2VyO1xyXG4gIH1cclxufVxyXG4iXX0=