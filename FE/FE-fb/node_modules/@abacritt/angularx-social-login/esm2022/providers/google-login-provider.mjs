import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
import { EventEmitter } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { filter, skip, take } from 'rxjs/operators';
const defaultInitOptions = {
    oneTapEnabled: true,
};
export class GoogleLoginProvider extends BaseLoginProvider {
    static { this.PROVIDER_ID = 'GOOGLE'; }
    constructor(clientId, initOptions) {
        super();
        this.clientId = clientId;
        this.initOptions = initOptions;
        this.changeUser = new EventEmitter();
        this._socialUser = new BehaviorSubject(null);
        this._accessToken = new BehaviorSubject(null);
        this._receivedAccessToken = new EventEmitter();
        this.initOptions = { ...defaultInitOptions, ...this.initOptions };
        // emit changeUser events but skip initial value from behaviorSubject
        this._socialUser.pipe(skip(1)).subscribe(this.changeUser);
        // emit receivedAccessToken but skip initial value from behaviorSubject
        this._accessToken.pipe(skip(1)).subscribe(this._receivedAccessToken);
    }
    initialize(autoLogin, lang) {
        return new Promise((resolve, reject) => {
            try {
                this.loadScript(GoogleLoginProvider.PROVIDER_ID, this.getGoogleLoginScriptSrc(lang), () => {
                    google.accounts.id.initialize({
                        client_id: this.clientId,
                        auto_select: autoLogin,
                        callback: ({ credential }) => {
                            const socialUser = this.createSocialUser(credential);
                            this._socialUser.next(socialUser);
                        },
                        prompt_parent_id: this.initOptions?.prompt_parent_id,
                        itp_support: this.initOptions.oneTapEnabled,
                        use_fedcm_for_prompt: this.initOptions.oneTapEnabled
                    });
                    if (this.initOptions.oneTapEnabled) {
                        this._socialUser
                            .pipe(filter((user) => user === null))
                            .subscribe(() => google.accounts.id.prompt(console.debug));
                    }
                    if (this.initOptions.scopes) {
                        const scope = this.initOptions.scopes instanceof Array
                            ? this.initOptions.scopes.filter((s) => s).join(' ')
                            : this.initOptions.scopes;
                        this._tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: this.clientId,
                            scope,
                            prompt: this.initOptions.prompt,
                            callback: (tokenResponse) => {
                                if (tokenResponse.error) {
                                    this._accessToken.error({
                                        code: tokenResponse.error,
                                        description: tokenResponse.error_description,
                                        uri: tokenResponse.error_uri,
                                    });
                                }
                                else {
                                    this._accessToken.next(tokenResponse.access_token);
                                }
                            },
                        });
                    }
                    resolve();
                });
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return new Promise((resolve, reject) => {
            if (this._socialUser.value) {
                resolve(this._socialUser.value);
            }
            else {
                reject(`No user is currently logged in with ${GoogleLoginProvider.PROVIDER_ID}`);
            }
        });
    }
    refreshToken() {
        return new Promise((resolve, reject) => {
            google.accounts.id.revoke(this._socialUser.value.id, (response) => {
                if (response.error)
                    reject(response.error);
                else
                    resolve(this._socialUser.value);
            });
        });
    }
    getAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                if (this._socialUser.value) {
                    reject('No token client was instantiated, you should specify some scopes.');
                }
                else {
                    reject('You should be logged-in first.');
                }
            }
            else {
                this._tokenClient.requestAccessToken({
                    hint: this._socialUser.value?.email,
                });
                this._receivedAccessToken.pipe(take(1)).subscribe(resolve);
            }
        });
    }
    revokeAccessToken() {
        return new Promise((resolve, reject) => {
            if (!this._tokenClient) {
                reject('No token client was instantiated, you should specify some scopes.');
            }
            else if (!this._accessToken.value) {
                reject('No access token to revoke');
            }
            else {
                google.accounts.oauth2.revoke(this._accessToken.value, () => {
                    this._accessToken.next(null);
                    resolve();
                });
            }
        });
    }
    signIn() {
        return Promise.reject('You should not call this method directly for Google, use "<asl-google-signin-button>" wrapper ' +
            'or generate the button yourself with "google.accounts.id.renderButton()" ' +
            '(https://developers.google.com/identity/gsi/web/guides/display-button#javascript)');
    }
    async signOut() {
        google.accounts.id.disableAutoSelect();
        this._socialUser.next(null);
    }
    createSocialUser(idToken) {
        const user = new SocialUser();
        user.idToken = idToken;
        const payload = this.decodeJwt(idToken);
        user.id = payload.sub;
        user.name = payload.name;
        user.email = payload.email;
        user.photoUrl = payload.picture;
        user.firstName = payload['given_name'];
        user.lastName = payload['family_name'];
        return user;
    }
    decodeJwt(idToken) {
        const base64Url = idToken.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(window.atob(base64)
            .split("")
            .map(function (c) {
            return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
        })
            .join(""));
        return JSON.parse(jsonPayload);
    }
    getGoogleLoginScriptSrc(lang) {
        return lang ?
            `https://accounts.google.com/gsi/client?hl=${lang}` :
            'https://accounts.google.com/gsi/client';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbGliL3NyYy9wcm92aWRlcnMvZ29vZ2xlLWxvZ2luLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUErQnBELE1BQU0sa0JBQWtCLEdBQXNCO0lBQzVDLGFBQWEsRUFBRSxJQUFJO0NBQ3BCLENBQUM7QUFFRixNQUFNLE9BQU8sbUJBQW9CLFNBQVEsaUJBQWlCO2FBQ2pDLGdCQUFXLEdBQVcsUUFBUSxBQUFuQixDQUFvQjtJQVN0RCxZQUNVLFFBQWdCLEVBQ1AsV0FBK0I7UUFFaEQsS0FBSyxFQUFFLENBQUM7UUFIQSxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ1AsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBVGxDLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBcUIsQ0FBQztRQUVsRCxnQkFBVyxHQUFHLElBQUksZUFBZSxDQUFvQixJQUFJLENBQUMsQ0FBQztRQUMzRCxpQkFBWSxHQUFHLElBQUksZUFBZSxDQUFnQixJQUFJLENBQUMsQ0FBQztRQUN4RCx5QkFBb0IsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO1FBU2pFLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxHQUFHLGtCQUFrQixFQUFFLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRWxFLHFFQUFxRTtRQUNyRSxJQUFJLENBQUMs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QUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMvRCxNQUFNLFdBQVcsR0FBRyxrQkFBa0IsQ0FDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7YUFDaEIsS0FBSyxDQUFDLEVBQUUsQ0FBQzthQUNULEdBQUcsQ0FBQyxVQUFVLENBQUM7WUFDZCxPQUFPLEdBQUcsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9ELENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxFQUFFLENBQUMsQ0FDWixDQUFDO1FBQ0YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxJQUFZO1FBQzFDLE9BQU8sSUFBSSxDQUFDLENBQUM7WUFDTiw2Q0FBNkMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUNyRCx3Q0FBd0MsQ0FBQztJQUNsRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZUxvZ2luUHJvdmlkZXIgfSBmcm9tICcuLi9lbnRpdGllcy9iYXNlLWxvZ2luLXByb3ZpZGVyJztcclxuaW1wb3J0IHsgU29jaWFsVXNlciB9IGZyb20gJy4uL2VudGl0aWVzL3NvY2lhbC11c2VyJztcclxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBmaWx0ZXIsIHNraXAsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEdvb2dsZUluaXRPcHRpb25zIHtcclxuICAvKipcclxuICAgKiBlbmFibGVzIHRoZSBPbmUgVGFwIG1lY2hhbmlzbSwgYW5kIG1ha2VzIGF1dG8tbG9naW4gcG9zc2libGVcclxuICAgKi9cclxuICBvbmVUYXBFbmFibGVkPzogYm9vbGVhbjtcclxuICAvKipcclxuICAgKiBsaXN0IG9mIHBlcm1pc3Npb24gc2NvcGVzIHRvIGdyYW50IGluIGNhc2Ugd2UgcmVxdWVzdCBhbiBhY2Nlc3MgdG9rZW5cclxuICAgKi9cclxuICBzY29wZXM/OiBzdHJpbmcgfCBzdHJpbmdbXTtcclxuIC8qKlxyXG4gICAqIFRoaXMgYXR0cmlidXRlIHNldHMgdGhlIERPTSBJRCBvZiB0aGUgY29udGFpbmVyIGVsZW1lbnQuIElmIGl0J3Mgbm90IHNldCwgdGhlIE9uZSBUYXAgcHJvbXB0IGlzIGRpc3BsYXllZCBpbiB0aGUgdG9wLXJpZ2h0IGNvcm5lciBvZiB0aGUgd2luZG93LlxyXG4gICAqL1xyXG4gIHByb21wdF9wYXJlbnRfaWQ/OiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIE9wdGlvbmFsLCBkZWZhdWx0cyB0byAnc2VsZWN0X2FjY291bnQnLlxyXG4gICAqIEEgc3BhY2UtZGVsaW1pdGVkLCBjYXNlLXNlbnNpdGl2ZSBsaXN0IG9mIHByb21wdHMgdG8gcHJlc2VudCB0aGVcclxuICAgKiB1c2VyLlxyXG4gICAqIFBvc3NpYmxlIHZhbHVlcyBhcmU6XHJcbiAgICogZW1wdHkgc3RyaW5nIFRoZSB1c2VyIHdpbGwgYmUgcHJvbXB0ZWQgb25seSB0aGUgZmlyc3QgdGltZSB5b3VyXHJcbiAgICogICAgIGFwcCByZXF1ZXN0cyBhY2Nlc3MuIENhbm5vdCBiZSBzcGVjaWZpZWQgd2l0aCBvdGhlciB2YWx1ZXMuXHJcbiAgICogJ25vbmUnIERvIG5vdCBkaXNwbGF5IGFueSBhdXRoZW50aWNhdGlvbiBvciBjb25zZW50IHNjcmVlbnMuIE11c3RcclxuICAgKiAgICAgbm90IGJlIHNwZWNpZmllZCB3aXRoIG90aGVyIHZhbHVlcy5cclxuICAgKiAnY29uc2VudCcgUHJvbXB0IHRoZSB1c2VyIGZvciBjb25zZW50LlxyXG4gICAqICdzZWxlY3RfYWNjb3VudCcgUHJvbXB0IHRoZSB1c2VyIHRvIHNlbGVjdCBhbiBhY2NvdW50LlxyXG4gICAqL1xyXG4gIHByb21wdD8gOiAnJyB8ICdub25lJyB8ICdjb25zZW50JyB8ICdzZWxlY3RfYWNjb3VudCc7XHJcbn1cclxuXHJcbmNvbnN0IGRlZmF1bHRJbml0T3B0aW9uczogR29vZ2xlSW5pdE9wdGlvbnMgPSB7XHJcbiAgb25lVGFwRW5hYmxlZDogdHJ1ZSxcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBHb29nbGVMb2dpblByb3ZpZGVyIGV4dGVuZHMgQmFzZUxvZ2luUHJvdmlkZXIge1xyXG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgUFJPVklERVJfSUQ6IHN0cmluZyA9ICdHT09HTEUnO1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgY2hhbmdlVXNlciA9IG5ldyBFdmVudEVtaXR0ZXI8U29jaWFsVXNlciB8IG51bGw+KCk7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3NvY2lhbFVzZXIgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFNvY2lhbFVzZXIgfCBudWxsPihudWxsKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IF9hY2Nlc3NUb2tlbiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD4obnVsbCk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBfcmVjZWl2ZWRBY2Nlc3NUb2tlbiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgX3Rva2VuQ2xpZW50OiBnb29nbGUuYWNjb3VudHMub2F1dGgyLlRva2VuQ2xpZW50IHwgdW5kZWZpbmVkO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgY2xpZW50SWQ6IHN0cmluZyxcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgaW5pdE9wdGlvbnM/OiBHb29nbGVJbml0T3B0aW9ucyxcclxuICApIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5pbml0T3B0aW9ucyA9IHsgLi4uZGVmYXVsdEluaXRPcHRpb25zLCAuLi50aGlzLmluaXRPcHRpb25zIH07XHJcblxyXG4gICAgLy8gZW1pdCBjaGFuZ2VVc2VyIGV2ZW50cyBidXQgc2tpcCBpbml0aWFsIHZhbHVlIGZyb20gYmVoYXZpb3JTdWJqZWN0XHJcbiAgICB0aGlzLl9zb2NpYWxVc2VyLnBpcGUoc2tpcCgxKSkuc3Vic2NyaWJlKHRoaXMuY2hhbmdlVXNlcik7XHJcblxyXG4gICAgLy8gZW1pdCByZWNlaXZlZEFjY2Vzc1Rva2VuIGJ1dCBza2lwIGluaXRpYWwgdmFsdWUgZnJvbSBiZWhhdmlvclN1YmplY3RcclxuICAgIHRoaXMuX2FjY2Vzc1Rva2VuLnBpcGUoc2tpcCgxKSkuc3Vic2NyaWJlKHRoaXMuX3JlY2VpdmVkQWNjZXNzVG9rZW4pO1xyXG4gIH1cclxuXHJcbiAgaW5pdGlhbGl6ZShhdXRvTG9naW4/OiBib29sZWFuLCBsYW5nPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIHRoaXMubG9hZFNjcmlwdChcclxuICAgICAgICAgIEdvb2dsZUxvZ2luUHJvdmlkZXIuUFJPVklERVJfSUQsXHJcbiAgICAgICAgICB0aGlzLmdldEdvb2dsZUxvZ2luU2NyaXB0U3JjKGxhbmcpLFxyXG4gICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICBnb29nbGUuYWNjb3VudHMuaWQuaW5pdGlhbGl6ZSh7XHJcbiAgICAgICAgICAgICAgY2xpZW50X2lkOiB0aGlzLmNsaWVudElkLFxyXG4gICAgICAgICAgICAgIGF1dG9fc2VsZWN0OiBhdXRvTG9naW4sXHJcbiAgICAgICAgICAgICAgY2FsbGJhY2s6ICh7IGNyZWRlbnRpYWwgfSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc29jaWFsVXNlciA9IHRoaXMuY3JlYXRlU29jaWFsVXNlcihjcmVkZW50aWFsKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NvY2lhbFVzZXIubmV4dChzb2NpYWxVc2VyKTtcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIHByb21wdF9wYXJlbnRfaWQ6IHRoaXMuaW5pdE9wdGlvbnM/LnByb21wdF9wYXJlbnRfaWQsXHJcbiAgICAgICAgICAgICAgaXRwX3N1cHBvcnQ6IHRoaXMuaW5pdE9wdGlvbnMub25lVGFwRW5hYmxlZCxcclxuICAgICAgICAgICAgICB1c2VfZmVkY21fZm9yX3Byb21wdDogdGhpcy5pbml0T3B0aW9ucy5vbmVUYXBFbmFibGVkXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5pdE9wdGlvbnMub25lVGFwRW5hYmxlZCkge1xyXG4gICAgICAgICAgICAgIHRoaXMuX3NvY2lhbFVzZXJcclxuICAgICAgICAgICAgICAgIC5waXBlKGZpbHRlcigodXNlcikgPT4gdXNlciA9PT0gbnVsbCkpXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IGdvb2dsZS5hY2NvdW50cy5pZC5wcm9tcHQoY29uc29sZS5kZWJ1ZykpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbml0T3B0aW9ucy5zY29wZXMpIHtcclxuICAgICAgICAgICAgICBjb25zdCBzY29wZSA9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmluaXRPcHRpb25zLnNjb3BlcyBpbnN0YW5jZW9mIEFycmF5XHJcbiAgICAgICAgICAgICAgICAgID8gdGhpcy5pbml0T3B0aW9ucy5zY29wZXMuZmlsdGVyKChzKSA9PiBzKS5qb2luKCcgJylcclxuICAgICAgICAgICAgICAgICAgOiB0aGlzLmluaXRPcHRpb25zLnNjb3BlcztcclxuXHJcbiAgICAgICAgICAgICAgdGhpcy5fdG9rZW5DbGllbnQgPSBnb29nbGUuYWNjb3VudHMub2F1dGgyLmluaXRUb2tlbkNsaWVudCh7XHJcbiAgICAgICAgICAgICAgICBjbGllbnRfaWQ6IHRoaXMuY2xpZW50SWQsXHJcbiAgICAgICAgICAgICAgICBzY29wZSxcclxuICAgICAgICAgICAgICAgIHByb21wdCA6IHRoaXMuaW5pdE9wdGlvbnMucHJvbXB0LFxyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2s6ICh0b2tlblJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGlmICh0b2tlblJlc3BvbnNlLmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWNjZXNzVG9rZW4uZXJyb3Ioe1xyXG4gICAgICAgICAgICAgICAgICAgICAgY29kZTogdG9rZW5SZXNwb25zZS5lcnJvcixcclxuICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0b2tlblJlc3BvbnNlLmVycm9yX2Rlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgdXJpOiB0b2tlblJlc3BvbnNlLmVycm9yX3VyaSxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY2Nlc3NUb2tlbi5uZXh0KHRva2VuUmVzcG9uc2UuYWNjZXNzX3Rva2VuKTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldExvZ2luU3RhdHVzKCk6IFByb21pc2U8U29jaWFsVXNlcj4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUpIHtcclxuICAgICAgICByZXNvbHZlKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlamVjdChcclxuICAgICAgICAgIGBObyB1c2VyIGlzIGN1cnJlbnRseSBsb2dnZWQgaW4gd2l0aCAke0dvb2dsZUxvZ2luUHJvdmlkZXIuUFJPVklERVJfSUR9YFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmVmcmVzaFRva2VuKCk6IFByb21pc2U8U29jaWFsVXNlciB8IG51bGw+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGdvb2dsZS5hY2NvdW50cy5pZC5yZXZva2UodGhpcy5fc29jaWFsVXNlci52YWx1ZS5pZCwgKHJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKSByZWplY3QocmVzcG9uc2UuZXJyb3IpO1xyXG4gICAgICAgIGVsc2UgcmVzb2x2ZSh0aGlzLl9zb2NpYWxVc2VyLnZhbHVlKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldEFjY2Vzc1Rva2VuKCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAoIXRoaXMuX3Rva2VuQ2xpZW50KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3NvY2lhbFVzZXIudmFsdWUpIHtcclxuICAgICAgICAgIHJlamVjdChcclxuICAgICAgICAgICAgJ05vIHRva2VuIGNsaWVudCB3YXMgaW5zdGFudGlhdGVkLCB5b3Ugc2hvdWxkIHNwZWNpZnkgc29tZSBzY29wZXMuJ1xyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVqZWN0KCdZb3Ugc2hvdWxkIGJlIGxvZ2dlZC1pbiBmaXJzdC4nKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5fdG9rZW5DbGllbnQucmVxdWVzdEFjY2Vzc1Rva2VuKHtcclxuICAgICAgICAgIGhpbnQ6IHRoaXMuX3NvY2lhbFVzZXIudmFsdWU/LmVtYWlsLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuX3JlY2VpdmVkQWNjZXNzVG9rZW4ucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUocmVzb2x2ZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmV2b2tlQWNjZXNzVG9rZW4oKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAoIXRoaXMuX3Rva2VuQ2xpZW50KSB7XHJcbiAgICAgICAgcmVqZWN0KFxyXG4gICAgICAgICAgJ05vIHRva2VuIGNsaWVudCB3YXMgaW5zdGFudGlhdGVkLCB5b3Ugc2hvdWxkIHNwZWNpZnkgc29tZSBzY29wZXMuJ1xyXG4gICAgICAgICk7XHJcbiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX2FjY2Vzc1Rva2VuLnZhbHVlKSB7XHJcbiAgICAgICAgcmVqZWN0KCdObyBhY2Nlc3MgdG9rZW4gdG8gcmV2b2tlJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZ29vZ2xlLmFjY291bnRzLm9hdXRoMi5yZXZva2UodGhpcy5fYWNjZXNzVG9rZW4udmFsdWUsICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuX2FjY2Vzc1Rva2VuLm5leHQobnVsbCk7XHJcbiAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2lnbkluKCk6IFByb21pc2U8U29jaWFsVXNlcj4ge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KFxyXG4gICAgICAnWW91IHNob3VsZCBub3QgY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSBmb3IgR29vZ2xlLCB1c2UgXCI8YXNsLWdvb2dsZS1zaWduaW4tYnV0dG9uPlwiIHdyYXBwZXIgJyArXHJcbiAgICAgICAgJ29yIGdlbmVyYXRlIHRoZSBidXR0b24geW91cnNlbGYgd2l0aCBcImdvb2dsZS5hY2NvdW50cy5pZC5yZW5kZXJCdXR0b24oKVwiICcgK1xyXG4gICAgICAgICcoaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vaWRlbnRpdHkvZ3NpL3dlYi9ndWlkZXMvZGlzcGxheS1idXR0b24jamF2YXNjcmlwdCknXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2lnbk91dCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGdvb2dsZS5hY2NvdW50cy5pZC5kaXNhYmxlQXV0b1NlbGVjdCgpO1xyXG4gICAgdGhpcy5fc29jaWFsVXNlci5uZXh0KG51bGwpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVTb2NpYWxVc2VyKGlkVG9rZW46IHN0cmluZykge1xyXG4gICAgY29uc3QgdXNlciA9IG5ldyBTb2NpYWxVc2VyKCk7XHJcbiAgICB1c2VyLmlkVG9rZW4gPSBpZFRva2VuO1xyXG4gICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZGVjb2RlSnd0KGlkVG9rZW4pO1xyXG4gICAgdXNlci5pZCA9IHBheWxvYWQuc3ViO1xyXG4gICAgdXNlci5uYW1lID0gcGF5bG9hZC5uYW1lO1xyXG4gICAgdXNlci5lbWFpbCA9IHBheWxvYWQuZW1haWw7XHJcbiAgICB1c2VyLnBob3RvVXJsID0gcGF5bG9hZC5waWN0dXJlO1xyXG4gICAgdXNlci5maXJzdE5hbWUgPSBwYXlsb2FkWydnaXZlbl9uYW1lJ107XHJcbiAgICB1c2VyLmxhc3ROYW1lID0gcGF5bG9hZFsnZmFtaWx5X25hbWUnXTtcclxuICAgIHJldHVybiB1c2VyO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkZWNvZGVKd3QoaWRUb2tlbjogc3RyaW5nKTogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPiB7XHJcbiAgICBjb25zdCBiYXNlNjRVcmwgPSBpZFRva2VuLnNwbGl0KFwiLlwiKVsxXTtcclxuICAgIGNvbnN0IGJhc2U2NCA9IGJhc2U2NFVybC5yZXBsYWNlKC8tL2csIFwiK1wiKS5yZXBsYWNlKC9fL2csIFwiL1wiKTtcclxuICAgIGNvbnN0IGpzb25QYXlsb2FkID0gZGVjb2RlVVJJQ29tcG9uZW50KFxyXG4gICAgICB3aW5kb3cuYXRvYihiYXNlNjQpXHJcbiAgICAgICAgLnNwbGl0KFwiXCIpXHJcbiAgICAgICAgLm1hcChmdW5jdGlvbiAoYykge1xyXG4gICAgICAgICAgcmV0dXJuIFwiJVwiICsgKFwiMDBcIiArIGMuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC0yKTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5qb2luKFwiXCIpXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoanNvblBheWxvYWQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRHb29nbGVMb2dpblNjcmlwdFNyYyhsYW5nOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGxhbmcgP1xyXG4gICAgICAgICAgIGBodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vZ3NpL2NsaWVudD9obD0ke2xhbmd9YCA6XHJcbiAgICAgICAgICAgJ2h0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9nc2kvY2xpZW50JztcclxuICB9XHJcbn1cclxuIl19