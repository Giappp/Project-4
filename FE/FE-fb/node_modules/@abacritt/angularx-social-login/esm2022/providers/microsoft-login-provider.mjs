import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
/**
 * Protocol modes supported by MSAL.
 */
export var ProtocolMode;
(function (ProtocolMode) {
    ProtocolMode["AAD"] = "AAD";
    ProtocolMode["OIDC"] = "OIDC";
})(ProtocolMode || (ProtocolMode = {}));
const COMMON_AUTHORITY = 'https://login.microsoftonline.com/common/';
/**
 * Microsoft Authentication using MSAL v2: https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-browser
 */
export class MicrosoftLoginProvider extends BaseLoginProvider {
    static { this.PROVIDER_ID = 'MICROSOFT'; }
    constructor(clientId, initOptions) {
        super();
        this.clientId = clientId;
        this.initOptions = {
            authority: COMMON_AUTHORITY,
            scopes: ['openid', 'email', 'profile', 'User.Read'],
            knownAuthorities: [],
            protocolMode: ProtocolMode.AAD,
            clientCapabilities: [],
            cacheLocation: 'sessionStorage'
        };
        this.initOptions = {
            ...this.initOptions,
            ...initOptions
        };
    }
    initialize() {
        return new Promise((resolve, reject) => {
            this.loadScript(MicrosoftLoginProvider.PROVIDER_ID, 'https://alcdn.msauth.net/browser/2.13.1/js/msal-browser.min.js', () => {
                try {
                    const config = {
                        auth: {
                            clientId: this.clientId,
                            redirectUri: this.initOptions.redirect_uri ?? location.origin,
                            authority: this.initOptions.authority,
                            knownAuthorities: this.initOptions.knownAuthorities,
                            protocolMode: this.initOptions.protocolMode,
                            clientCapabilities: this.initOptions.clientCapabilities
                        },
                        cache: !this.initOptions.cacheLocation ? null : {
                            cacheLocation: this.initOptions.cacheLocation
                        }
                    };
                    this._instance = new msal.PublicClientApplication(config);
                    resolve();
                }
                catch (e) {
                    reject(e);
                }
            });
        });
    }
    getSocialUser(loginResponse) {
        return new Promise((resolve, reject) => {
            //After login, use Microsoft Graph API to get user info
            let meRequest = new XMLHttpRequest();
            meRequest.onreadystatechange = () => {
                if (meRequest.readyState == 4) {
                    try {
                        if (meRequest.status == 200) {
                            let userInfo = JSON.parse(meRequest.responseText);
                            let user = new SocialUser();
                            user.provider = MicrosoftLoginProvider.PROVIDER_ID;
                            user.id = loginResponse.idToken;
                            user.authToken = loginResponse.accessToken;
                            user.name = loginResponse.idTokenClaims.name;
                            user.email = loginResponse.account.username;
                            user.idToken = loginResponse.idToken;
                            user.response = loginResponse;
                            user.firstName = userInfo.givenName;
                            user.lastName = userInfo.surname;
                            resolve(user);
                        }
                        else {
                            reject(`Error retrieving user info: ${meRequest.status}`);
                        }
                    }
                    catch (err) {
                        reject(err);
                    }
                }
            };
            //Microsoft Graph ME Endpoint: https://docs.microsoft.com/en-us/graph/api/user-get?view=graph-rest-1.0&tabs=http
            meRequest.open('GET', 'https://graph.microsoft.com/v1.0/me');
            meRequest.setRequestHeader('Authorization', `Bearer ${loginResponse.accessToken}`);
            try {
                meRequest.send();
            }
            catch (err) {
                reject(err);
            }
        });
    }
    async getLoginStatus() {
        const accounts = this._instance.getAllAccounts();
        if (accounts?.length > 0) {
            const loginResponse = await this._instance.ssoSilent({
                scopes: this.initOptions.scopes,
                loginHint: accounts[0].username
            });
            return await this.getSocialUser(loginResponse);
        }
        else {
            throw `No user is currently logged in with ${MicrosoftLoginProvider.PROVIDER_ID}`;
        }
    }
    async signIn() {
        const loginResponse = await this._instance.loginPopup({
            scopes: this.initOptions.scopes,
            prompt: this.initOptions.prompt,
        });
        return await this.getSocialUser(loginResponse);
    }
    async signOut(revoke) {
        const accounts = this._instance.getAllAccounts();
        if (accounts?.length > 0) {
            await this._instance.logoutPopup({
                account: accounts[0],
                postLogoutRedirectUri: this.initOptions.logout_redirect_uri ?? this.initOptions.redirect_uri ?? location.href
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWljcm9zb2Z0LWxvZ2luLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbGliL3NyYy9wcm92aWRlcnMvbWljcm9zb2Z0LWxvZ2luLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVyRDs7R0FFRztBQUNILE1BQU0sQ0FBTixJQUFZLFlBR1g7QUFIRCxXQUFZLFlBQVk7SUFDdEIsMkJBQVcsQ0FBQTtJQUNYLDZCQUFhLENBQUE7QUFDZixDQUFDLEVBSFcsWUFBWSxLQUFaLFlBQVksUUFHdkI7QUFrRkQsTUFBTSxnQkFBZ0IsR0FBVywyQ0FBMkMsQ0FBQztBQUU3RTs7R0FFRztBQUNILE1BQU0sT0FBTyxzQkFBdUIsU0FBUSxpQkFBaUI7YUFFcEMsZ0JBQVcsR0FBVyxXQUFXLEFBQXRCLENBQXVCO0lBV3pELFlBQ1UsUUFBZ0IsRUFDeEIsV0FBOEI7UUFFOUIsS0FBSyxFQUFFLENBQUM7UUFIQSxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBVmxCLGdCQUFXLEdBQXFCO1lBQ3RDLFNBQVMsRUFBRSxnQkFBZ0I7WUFDM0IsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxDQUFDO1lBQ25ELGdCQUFnQixFQUFFLEVBQUU7WUFDcEIsWUFBWSxFQUFFLFlBQVksQ0FBQyxHQUFHO1lBQzlCLGtCQUFrQixFQUFFLEVBQUU7WUFDdEIsYUFBYSxFQUFFLGdCQUFnQjtTQUNoQyxDQUFDO1FBUUEsSUFBSSxDQUFDLFdBQVcsR0FBRztZQUNqQixHQUFHLElBQUksQ0FBQyxXQUFXO1lBQ25CLEdBQUcsV0FBVztTQUNmLENBQUM7SUFDSixDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxPQUFPLENB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Q0FBQyxNQUFNO1NBQ2hDLENBQUMsQ0FBQztRQUNILE9BQU8sTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQWdCO1FBQzVCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDakQsSUFBSSxRQUFRLEVBQUUsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUM7Z0JBQy9CLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNwQixxQkFBcUIsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLG1CQUFtQixJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxJQUFJLFFBQVEsQ0FBQyxJQUFJO2FBQzlHLENBQUMsQ0FBQTtRQUNKLENBQUM7SUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZUxvZ2luUHJvdmlkZXIgfSBmcm9tICcuLi9lbnRpdGllcy9iYXNlLWxvZ2luLXByb3ZpZGVyJztcclxuaW1wb3J0IHsgU29jaWFsVXNlciB9IGZyb20gJy4uL2VudGl0aWVzL3NvY2lhbC11c2VyJztcclxuXHJcbi8qKlxyXG4gKiBQcm90b2NvbCBtb2RlcyBzdXBwb3J0ZWQgYnkgTVNBTC5cclxuICovXHJcbmV4cG9ydCBlbnVtIFByb3RvY29sTW9kZSB7XHJcbiAgQUFEID0gJ0FBRCcsXHJcbiAgT0lEQyA9ICdPSURDJ1xyXG59XHJcblxyXG4vKipcclxuICogSW5pdGlhbGl6YXRpb24gT3B0aW9ucyBmb3IgTWljcm9zb2Z0IFByb3ZpZGVyOiBodHRwczovL2dpdGh1Yi5jb20vQXp1cmVBRC9taWNyb3NvZnQtYXV0aGVudGljYXRpb24tbGlicmFyeS1mb3ItanMvYmxvYi9kZXYvbGliL21zYWwtYnJvd3Nlci9kb2NzL2luaXRpYWxpemF0aW9uLm1kXHJcbiAqIERldGFpbHMgKG5vdCBhbGwgb3B0aW9ucyBhcmUgc3VwcG9ydGVkKTogaHR0cHM6Ly9naXRodWIuY29tL0F6dXJlQUQvbWljcm9zb2Z0LWF1dGhlbnRpY2F0aW9uLWxpYnJhcnktZm9yLWpzL2Jsb2IvZGV2L2xpYi9tc2FsLWJyb3dzZXIvZG9jcy9jb25maWd1cmF0aW9uLm1kXHJcbiAqL1xyXG5leHBvcnQgdHlwZSBNaWNyb3NvZnRPcHRpb25zID0ge1xyXG4gIHJlZGlyZWN0X3VyaT86IHN0cmluZyxcclxuICBsb2dvdXRfcmVkaXJlY3RfdXJpPzogc3RyaW5nLFxyXG4gIGF1dGhvcml0eT86IHN0cmluZyxcclxuICBrbm93bkF1dGhvcml0aWVzPzogc3RyaW5nW10sXHJcbiAgcHJvdG9jb2xNb2RlPzogUHJvdG9jb2xNb2RlLFxyXG4gIGNsaWVudENhcGFiaWxpdGllcz86IHN0cmluZ1tdLFxyXG4gIGNhY2hlTG9jYXRpb24/OiBzdHJpbmcsXHJcbiAgc2NvcGVzPzogc3RyaW5nW10sXHJcbiAgcHJvbXB0Pzogc3RyaW5nLFxyXG59O1xyXG5cclxuLy8gQ29sbGVjdGlvbiBvZiBpbnRlcm5hbCBNU0FMIGludGVyZmFjZXMgZnJvbTogaHR0cHM6Ly9naXRodWIuY29tL0F6dXJlQUQvbWljcm9zb2Z0LWF1dGhlbnRpY2F0aW9uLWxpYnJhcnktZm9yLWpzL3RyZWUvZGV2L2xpYi9tc2FsLWJyb3dzZXIvc3JjXHJcblxyXG5pbnRlcmZhY2UgTVNBTEFjY291bnQge1xyXG4gIGVudmlyb25tZW50OiBzdHJpbmc7XHJcbiAgaG9tZUFjY291bnRJZDogc3RyaW5nO1xyXG4gIHRlbmFudElkOiBzdHJpbmc7XHJcbiAgdXNlcm5hbWU6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIE1TR3JhcGhVc2VySW5mbyB7XHJcbiAgYnVzaW5lc3NQaG9uZXM6IHN0cmluZ1tdO1xyXG4gIGRpc3BsYXlOYW1lOiBzdHJpbmc7XHJcbiAgZ2l2ZW5OYW1lOiBzdHJpbmc7XHJcbiAgaWQ6IHN0cmluZztcclxuICBqb2JUaXRsZTogc3RyaW5nO1xyXG4gIG1haWw6IHN0cmluZztcclxuICBtb2JpbGVQaG9uZTogc3RyaW5nO1xyXG4gIG9mZmljZUxvY2F0aW9uOiBzdHJpbmc7XHJcbiAgcHJlZmVycmVkTGFuZ3VhZ2U6IHN0cmluZztcclxuICBzdXJuYW1lOiBzdHJpbmc7XHJcbiAgdXNlclByaW5jaXBhbE5hbWU6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIE1TQUxMb2dpblJlcXVlc3Qge1xyXG4gIHNjb3Blcz86IHN0cmluZ1tdO1xyXG4gIHNpZD86IHN0cmluZztcclxuICBsb2dpbkhpbnQ/OiBzdHJpbmc7XHJcbiAgZG9tYWluSGludD86IHN0cmluZztcclxuICBwcm9tcHQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBNU0FMTG9naW5SZXNwb25zZSB7XHJcbiAgYWNjZXNzVG9rZW46IHN0cmluZztcclxuICBhY2NvdW50OiBNU0FMQWNjb3VudDtcclxuICBleHBpcmVzT246IERhdGU7XHJcbiAgZXh0RXhwaXJlc09uOiBEYXRlO1xyXG4gIGZhbWlseUlkOiBzdHJpbmc7XHJcbiAgZnJvbUNhY2hlOiBib29sZWFuO1xyXG4gIGlkVG9rZW46IHN0cmluZztcclxuICBpZFRva2VuQ2xhaW1zOiBhbnk7XHJcbiAgc2NvcGVzOiBzdHJpbmdbXTtcclxuICBzdGF0ZTogc3RyaW5nO1xyXG4gIHRlbmFudElkOiBzdHJpbmc7XHJcbiAgdW5pcXVlSWQ6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIE1TQUxMb2dvdXRSZXF1ZXN0IHtcclxuICBhY2NvdW50PzogTVNBTEFjY291bnQ7XHJcbiAgcG9zdExvZ291dFJlZGlyZWN0VXJpPzogc3RyaW5nO1xyXG4gIGF1dGhvcml0eT86IHN0cmluZztcclxuICBjb3JyZWxhdGlvbklkPzogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgTVNBTENsaWVudEFwcGxpY2F0aW9uIHtcclxuICBnZXRBbGxBY2NvdW50cygpOiBNU0FMQWNjb3VudFtdO1xyXG4gIGxvZ291dFBvcHVwKGxvZ291dFJlcXVlc3Q/OiBNU0FMTG9nb3V0UmVxdWVzdCk6IFByb21pc2U8dm9pZD47XHJcbiAgbG9naW5Qb3B1cChsb2dpblJlcXVlc3Q6IE1TQUxMb2dpblJlcXVlc3QpOiBQcm9taXNlPE1TQUxMb2dpblJlc3BvbnNlPjtcclxuICBzc29TaWxlbnQobG9naW5SZXF1ZXN0OiBNU0FMTG9naW5SZXF1ZXN0KTogUHJvbWlzZTxNU0FMTG9naW5SZXNwb25zZT47XHJcbiAgYWNxdWlyZVRva2VuU2lsZW50KGxvZ2luUmVxdWVzdDogTVNBTExvZ2luUmVxdWVzdCk6IFByb21pc2U8TVNBTExvZ2luUmVzcG9uc2U+O1xyXG4gIGdldEFjY291bnRCeUhvbWVJZChob21lQWNjb3VudElkOiBzdHJpbmcpOiBNU0FMQWNjb3VudDtcclxufVxyXG5cclxuZGVjbGFyZSBsZXQgbXNhbDogYW55O1xyXG5cclxuY29uc3QgQ09NTU9OX0FVVEhPUklUWTogc3RyaW5nID0gJ2h0dHBzOi8vbG9naW4ubWljcm9zb2Z0b25saW5lLmNvbS9jb21tb24vJztcclxuXHJcbi8qKlxyXG4gKiBNaWNyb3NvZnQgQXV0aGVudGljYXRpb24gdXNpbmcgTVNBTCB2MjogaHR0cHM6Ly9naXRodWIuY29tL0F6dXJlQUQvbWljcm9zb2Z0LWF1dGhlbnRpY2F0aW9uLWxpYnJhcnktZm9yLWpzL3RyZWUvZGV2L2xpYi9tc2FsLWJyb3dzZXJcclxuICovXHJcbmV4cG9ydCBjbGFzcyBNaWNyb3NvZnRMb2dpblByb3ZpZGVyIGV4dGVuZHMgQmFzZUxvZ2luUHJvdmlkZXIge1xyXG4gIHByaXZhdGUgX2luc3RhbmNlOiBNU0FMQ2xpZW50QXBwbGljYXRpb247XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBQUk9WSURFUl9JRDogc3RyaW5nID0gJ01JQ1JPU09GVCc7XHJcblxyXG4gIHByaXZhdGUgaW5pdE9wdGlvbnM6IE1pY3Jvc29mdE9wdGlvbnMgPSB7XHJcbiAgICBhdXRob3JpdHk6IENPTU1PTl9BVVRIT1JJVFksXHJcbiAgICBzY29wZXM6IFsnb3BlbmlkJywgJ2VtYWlsJywgJ3Byb2ZpbGUnLCAnVXNlci5SZWFkJ10sXHJcbiAgICBrbm93bkF1dGhvcml0aWVzOiBbXSxcclxuICAgIHByb3RvY29sTW9kZTogUHJvdG9jb2xNb2RlLkFBRCxcclxuICAgIGNsaWVudENhcGFiaWxpdGllczogW10sXHJcbiAgICBjYWNoZUxvY2F0aW9uOiAnc2Vzc2lvblN0b3JhZ2UnXHJcbiAgfTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGNsaWVudElkOiBzdHJpbmcsXHJcbiAgICBpbml0T3B0aW9ucz86IE1pY3Jvc29mdE9wdGlvbnNcclxuICApIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5pbml0T3B0aW9ucyA9IHtcclxuICAgICAgLi4udGhpcy5pbml0T3B0aW9ucyxcclxuICAgICAgLi4uaW5pdE9wdGlvbnNcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXplKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdGhpcy5sb2FkU2NyaXB0KFxyXG4gICAgICAgIE1pY3Jvc29mdExvZ2luUHJvdmlkZXIuUFJPVklERVJfSUQsXHJcbiAgICAgICAgJ2h0dHBzOi8vYWxjZG4ubXNhdXRoLm5ldC9icm93c2VyLzIuMTMuMS9qcy9tc2FsLWJyb3dzZXIubWluLmpzJyxcclxuICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBjb25maWcgPSB7XHJcbiAgICAgICAgICAgICAgYXV0aDoge1xyXG4gICAgICAgICAgICAgICAgY2xpZW50SWQ6IHRoaXMuY2xpZW50SWQsXHJcbiAgICAgICAgICAgICAgICByZWRpcmVjdFVyaTogdGhpcy5pbml0T3B0aW9ucy5yZWRpcmVjdF91cmkgPz8gbG9jYXRpb24ub3JpZ2luLFxyXG4gICAgICAgICAgICAgICAgYXV0aG9yaXR5OiB0aGlzLmluaXRPcHRpb25zLmF1dGhvcml0eSxcclxuICAgICAgICAgICAgICAgIGtub3duQXV0aG9yaXRpZXM6IHRoaXMuaW5pdE9wdGlvbnMua25vd25BdXRob3JpdGllcyxcclxuICAgICAgICAgICAgICAgIHByb3RvY29sTW9kZTogdGhpcy5pbml0T3B0aW9ucy5wcm90b2NvbE1vZGUsXHJcbiAgICAgICAgICAgICAgICBjbGllbnRDYXBhYmlsaXRpZXM6IHRoaXMuaW5pdE9wdGlvbnMuY2xpZW50Q2FwYWJpbGl0aWVzXHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICBjYWNoZTogIXRoaXMuaW5pdE9wdGlvbnMuY2FjaGVMb2NhdGlvbiA/IG51bGwgOiB7XHJcbiAgICAgICAgICAgICAgICBjYWNoZUxvY2F0aW9uOiB0aGlzLmluaXRPcHRpb25zLmNhY2hlTG9jYXRpb25cclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB0aGlzLl9pbnN0YW5jZSA9IG5ldyBtc2FsLlB1YmxpY0NsaWVudEFwcGxpY2F0aW9uKGNvbmZpZyk7XHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRTb2NpYWxVc2VyKGxvZ2luUmVzcG9uc2UpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxTb2NpYWxVc2VyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIC8vQWZ0ZXIgbG9naW4sIHVzZSBNaWNyb3NvZnQgR3JhcGggQVBJIHRvIGdldCB1c2VyIGluZm9cclxuICAgICAgbGV0IG1lUmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gICAgICBtZVJlcXVlc3Qub25yZWFkeXN0YXRlY2hhbmdlID0gKCkgPT4ge1xyXG4gICAgICAgIGlmIChtZVJlcXVlc3QucmVhZHlTdGF0ZSA9PSA0KSB7XHJcbiAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAobWVSZXF1ZXN0LnN0YXR1cyA9PSAyMDApIHtcclxuICAgICAgICAgICAgICBsZXQgdXNlckluZm8gPSA8TVNHcmFwaFVzZXJJbmZvPkpTT04ucGFyc2UobWVSZXF1ZXN0LnJlc3BvbnNlVGV4dCk7XHJcblxyXG4gICAgICAgICAgICAgIGxldCB1c2VyOiBTb2NpYWxVc2VyID0gbmV3IFNvY2lhbFVzZXIoKTtcclxuICAgICAgICAgICAgICB1c2VyLnByb3ZpZGVyID0gTWljcm9zb2Z0TG9naW5Qcm92aWRlci5QUk9WSURFUl9JRDtcclxuICAgICAgICAgICAgICB1c2VyLmlkID0gbG9naW5SZXNwb25zZS5pZFRva2VuO1xyXG4gICAgICAgICAgICAgIHVzZXIuYXV0aFRva2VuID0gbG9naW5SZXNwb25zZS5hY2Nlc3NUb2tlbjtcclxuICAgICAgICAgICAgICB1c2VyLm5hbWUgPSBsb2dpblJlc3BvbnNlLmlkVG9rZW5DbGFpbXMubmFtZTtcclxuICAgICAgICAgICAgICB1c2VyLmVtYWlsID0gbG9naW5SZXNwb25zZS5hY2NvdW50LnVzZXJuYW1lO1xyXG4gICAgICAgICAgICAgIHVzZXIuaWRUb2tlbiA9IGxvZ2luUmVzcG9uc2UuaWRUb2tlbjtcclxuICAgICAgICAgICAgICB1c2VyLnJlc3BvbnNlID0gbG9naW5SZXNwb25zZTtcclxuICAgICAgICAgICAgICB1c2VyLmZpcnN0TmFtZSA9IHVzZXJJbmZvLmdpdmVuTmFtZTtcclxuICAgICAgICAgICAgICB1c2VyLmxhc3ROYW1lID0gdXNlckluZm8uc3VybmFtZTtcclxuXHJcbiAgICAgICAgICAgICAgcmVzb2x2ZSh1c2VyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByZWplY3QoYEVycm9yIHJldHJpZXZpbmcgdXNlciBpbmZvOiAke21lUmVxdWVzdC5zdGF0dXN9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcblxyXG4gICAgICAvL01pY3Jvc29mdCBHcmFwaCBNRSBFbmRwb2ludDogaHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvZ3JhcGgvYXBpL3VzZXItZ2V0P3ZpZXc9Z3JhcGgtcmVzdC0xLjAmdGFicz1odHRwXHJcbiAgICAgIG1lUmVxdWVzdC5vcGVuKCdHRVQnLCAnaHR0cHM6Ly9ncmFwaC5taWNyb3NvZnQuY29tL3YxLjAvbWUnKTtcclxuICAgICAgbWVSZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7bG9naW5SZXNwb25zZS5hY2Nlc3NUb2tlbn1gKTtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBtZVJlcXVlc3Quc2VuZCgpO1xyXG4gICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRMb2dpblN0YXR1cygpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIGNvbnN0IGFjY291bnRzID0gdGhpcy5faW5zdGFuY2UuZ2V0QWxsQWNjb3VudHMoKTtcclxuICAgIGlmIChhY2NvdW50cz8ubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgdGhpcy5faW5zdGFuY2Uuc3NvU2lsZW50KHtcclxuICAgICAgICBzY29wZXM6IHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzLFxyXG4gICAgICAgIGxvZ2luSGludDogYWNjb3VudHNbMF0udXNlcm5hbWVcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFNvY2lhbFVzZXIobG9naW5SZXNwb25zZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aHJvdyBgTm8gdXNlciBpcyBjdXJyZW50bHkgbG9nZ2VkIGluIHdpdGggJHtNaWNyb3NvZnRMb2dpblByb3ZpZGVyLlBST1ZJREVSX0lEfWA7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBzaWduSW4oKTogUHJvbWlzZTxTb2NpYWxVc2VyPiB7XHJcbiAgICBjb25zdCBsb2dpblJlc3BvbnNlID0gYXdhaXQgdGhpcy5faW5zdGFuY2UubG9naW5Qb3B1cCh7XHJcbiAgICAgIHNjb3BlczogdGhpcy5pbml0T3B0aW9ucy5zY29wZXMsXHJcbiAgICAgIHByb21wdDogdGhpcy5pbml0T3B0aW9ucy5wcm9tcHQsXHJcbiAgICB9KTtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFNvY2lhbFVzZXIobG9naW5SZXNwb25zZSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzaWduT3V0KHJldm9rZT86IGJvb2xlYW4pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IGFjY291bnRzID0gdGhpcy5faW5zdGFuY2UuZ2V0QWxsQWNjb3VudHMoKTtcclxuICAgIGlmIChhY2NvdW50cz8ubGVuZ3RoID4gMCkge1xyXG4gICAgICBhd2FpdCB0aGlzLl9pbnN0YW5jZS5sb2dvdXRQb3B1cCh7XHJcbiAgICAgICAgYWNjb3VudDogYWNjb3VudHNbMF0sXHJcbiAgICAgICAgcG9zdExvZ291dFJlZGlyZWN0VXJpOiB0aGlzLmluaXRPcHRpb25zLmxvZ291dF9yZWRpcmVjdF91cmkgPz8gdGhpcy5pbml0T3B0aW9ucy5yZWRpcmVjdF91cmkgPz8gbG9jYXRpb24uaHJlZlxyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=